function run(e,t,n){n.ga("create","UA-75878329-2","auto"),e.$on("$stateChangeSuccess",function(e){n.ga("send","pageview",t.path())})}angular.module("DojoIBL",["ui.router","ngRoute","ngResource","angular-cache","ngDragDrop","localytics.directives","summernote","ui.select","ngSanitize","infinite-scroll","textAngular","pascalprecht.translate","ngFileUpload","ncy-angular-breadcrumb","angular-table","luegg.directives","ngEmoticons","vButton","ui.sortable","ngAudio","ui.bootstrap","ui.codemirror","ngLetterAvatar","toaster","ngAnimate","ui.footable","ui.calendar","datePicker"]).config(["$translateProvider","$urlRouterProvider",function(e,t){t.otherwise("/error"),e.useStaticFilesLoader({files:[{prefix:"/src/assets/i18n/",suffix:".json"}]}),e.preferredLanguage("en")}]).config(["$breadcrumbProvider",function(e){e.setOptions({prefixStateName:"home",template:"bootstrap2"})}]).run(["$http","$location","$window",function(e,t,n){var o=t.absUrl();localStorage.getItem("accessToken")?"localhost:8080"==location.host?location.protocol+"//"+location.host+"/"!=o&&location.protocol+"//"+location.host+"/index.html"!=o||(window.location=location.protocol+"//"+location.host+"/main.html#/home"):"http://dojo-ibl.appspot.com/"!=o&&"http://dojo-ibl.appspot.com/index.html"!=o&&"https://dojo-ibl.appspot.com/"!=o&&"https://dojo-ibl.appspot.com/index.html"!=o||(window.location="https://dojo-ibl.appspot.com/main.html#/home"):"localhost:8080"==location.host?o.indexOf("localhost:8080/main.html#/oauth/")==-1&&o.indexOf("localhost:8080/main.html#/")!==-1&&(window.location="http://localhost:8080"):o.indexOf("dojo-ibl.appspot.com/main.html#/oauth/")==-1&&o.indexOf("dojo-ibl.appspot.com/main.html#/")!==-1&&(window.location="http://dojo-ibl.appspot.com"),e.defaults.headers.common.Authorization="GoogleLogin auth="+localStorage.getItem("accessToken")}]).filter("unsafe",["$sce",function(e){return e.trustAsHtml}]).filter("orderByDayNumber",function(){return function(e,t,n){var o=[];return angular.forEach(e,function(e){o.push(e)}),o.sort(function(e,n){return e[t]>n[t]?1:-1}),n&&o.reverse(),o}}).filter("isEmpty",function(){var e;return function(t){for(e in t)if(t.hasOwnProperty(e))return!1;return!0}}).filter("timeago",function(){return function(e){return moment(e).fromNow()}}).directive("timeago",function(){return{restrict:"A",link:function(e,t,n){n.$observe("timeago",function(){t.text(moment(n.timeago).fromNow())})}}}).run(run),run.$inject=["$rootScope","$location","$window"],angular.module("DojoIBL").config(["$stateProvider","$routeProvider",function(e,t,n){e.state("home",{url:"/home",templateUrl:"/src/components/home/home.template.html",controller:"HomeController",ncyBreadcrumb:{label:"{{'dibl.toolbar.home' | translate}}"}}).state("inquiry",{url:"/inquiry",abstract:!0,views:{"":{templateUrl:"/src/components/run/inquiry.structure.template.html"}}}).state("inquiry.home",{url:"/:runId",templateUrl:"/src/components/run/inquiry.template.html",controller:"InquiryController",ncyBreadcrumb:{label:"{{'dibl.toolbar.phases' | translate}} "},resolve:{security:["$q","$stateParams","AccountService","UserService","toaster","$location",function(e,t,n,o,r,a){o.checkAccess()}]}}).state("inquiry.phase",{url:"/:runId/phase/:phase",templateUrl:"/src/components/activity/phase.template.html",controller:"PhaseController",ncyBreadcrumb:{label:"{{'dibl.toolbar.phase' | translate}}",parent:"inquiry.home"}}).state("inquiry.activity",{url:"/:runId/phase/:phase/activity/:activityId",templateUrl:"/src/components/activity/activity.template.html",controller:"ActivityController",ncyBreadcrumb:{label:"{{'dibl.toolbar.activity' | translate}}",parent:"inquiry.phase"}}).state("inquiry.timeline",{url:"/:runId/timeline",templateUrl:"/src/components/run/timeline.template.html",controller:"TimelineController",ncyBreadcrumb:{label:"{{'dibl.toolbar.timeline' | translate}}",parent:"inquiry.home"}}).state("inquiry.calendar",{url:"/:gameId/:runId/calendar",templateUrl:"/src/components/run/calendar.template.html",controller:"CalendarController",ncyBreadcrumb:{label:"{{'dibl.toolbar.calendar' | translate}}",parent:"inquiry.home"}}).state("editgame",{url:"/inquiry/:gameId/edit",templateUrl:"/src/components/home/game.edit.template.html",controller:"InquiryEditGameController",ncyBreadcrumb:{label:"{{'dibl.toolbar.editstructure' | translate}}"}}).state("editrun",{url:"/inquiry/:gameId/run/:runId/edit",templateUrl:"/src/components/run/inquiry.edit.template.html",controller:"InquiryEditRunController",ncyBreadcrumb:{label:"{{'dibl.toolbar.editrun' | translate}}",parent:"inquiry.home"}}).state("profiles",{url:"/profiles",templateUrl:"/src/components/account/profiles.template.html",controller:"ProfilesController",ncyBreadcrumb:{label:"Profiles"}}).state("profileAccount",{url:"/profile/:fullId",templateUrl:"/src/components/account/profile.template.html",controller:"ProfileController",ncyBreadcrumb:{label:"{{'dibl.toolbar.profile' | translate}}"}}).state("oauth",{url:"/oauth/:accessToken/:type/:exp",controller:"OauthController"}).state("error",{url:"/error",templateUrl:"/src/components/common/error.template.html"})}]),angular.module("DojoIBL").directive("diblFooter",function(){return{restrict:"E",templateUrl:"/src/components/common/footer.directive.html",controller:"FooterController"}}),angular.module("DojoIBL").directive("diblHeader",function(){return{restrict:"E",templateUrl:"/src/components/common/header.directive.html",controller:"HeaderController"}}),angular.module("DojoIBL").directive("original",function(){return{restrict:"A",scope:{hires:"@"},link:function(e,t,n){t.one("load",function(){t.attr("ng-src",e.src)})}}}),angular.module("DojoIBL").directive("scroll",["$window",function(e){return function(t,n,o){angular.element(e).bind("scroll",function(){this.pageYOffset>=165?t.boolChangeClass=!0:t.boolChangeClass=!1,t.$apply()})}}]),angular.module("DojoIBL").directive("diblSidebar",function(){return{restrict:"E",templateUrl:"/src/components/common/sidebar.directive.html",controller:"SidebarController"}}),angular.module("DojoIBL").directive("diblToolbar",function(){return{restrict:"E",templateUrl:"/src/components/common/toolbar.directive.html",controller:"ToolbarController"}}),angular.module("DojoIBL").directive("scrollPosition",["$window",function(e){return{scope:{scroll:"=scrollPosition"},link:function(t,n,o){var r=angular.element(e),a=function(){t.scroll=r.scrollTop()};r.on("scroll",t.$apply.bind(t,a)),a()}}}]).directive("chat",["$window",function(e){return{restrict:"A",link:function(e,t,n,o){e.$watch(function(){return t[0].childNodes.length},function(e,n){e!==n&&(console.log("scroll"),t.scrollTop(t[0].scrollHeight))})}}}]).directive("ngEnter",function(){return{restrict:"A",link:function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}}).directive("messageL",function(){return{restrict:"E",replace:!0,scope:{message:"="},templateUrl:"/src/components/message/messagel.directive.template.html",link:function(e,t,n){}}}).directive("messageR",function(){return{restrict:"E",replace:!0,scope:{message:"="},templateUrl:"/src/components/message/messager.directive.template.html",link:function(e,t,n){}}}),angular.module("DojoIBL").directive("comment",function(){return{restrict:"EA",templateUrl:"/src/templates/directives/response.html"}}),angular.module("DojoIBL").directive("data",["$compile","$parse","ResponseService","AccountService","$stateParams","UserService","ActivityService","$templateRequest","config",function(e,t,n,o,r,a,s,i,c){return{restrict:"E",replace:!0,scope:{response:"="},templateUrl:"/src/components/response/data.template.html",link:function(e,t,r){if(o.myDetails().then(function(t){e.myAccount=t}),a.getUserByAccount(e.response.runId,e.response.userEmail.split(":")[1]).then(function(t){e.user=t}),e.removeComment=function(e){swal({title:"Are you sure?",text:"You will not be able to recover it in the future!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, remove it!",closeOnConfirm:!1},function(){swal("Removed!","Your contribution has been removed from the inquiry","success"),n.deleteResponse(e.responseId)})},e.response.responseValue.indexOf("{")==-1)e.extension="text",e.resource=e.response.responseValue;else{var s=JSON.parse(e.response.responseValue);s.documentUrl&&(e.type=s.fileType,e.name=s.fileName,e.extension="document",e.resource=s.documentUrl),s.excelUrl&&(e.type=s.fileType,e.name=s.fileName,e.extension="excel",e.resource=s.excelUrl),s.pdfUrl&&(e.type=s.fileType,e.name=s.fileName,e.extension="pdf",e.resource=s.pdfUrl),s.videoUrl&&(e.type=s.fileType,e.name=s.fileName,e.extension="video",e.resource=s.videoUrl),s.imageUrl&&(e.type=s.fileType,e.name=s.fileName,e.extension="image",e.resource=s.imageUrl),s.audioUrl&&(e.type=s.fileType,e.name=s.fileName,e.extension="audio",e.resource=s.audioUrl)}}}}]),angular.module("DojoIBL").directive("response",["$compile","ResponseService","AccountService","$stateParams","UserService","ActivityService","RunService","$location","$anchorScroll","$sce",function(e,t,n,o,r,a,s,i,c,l){return{restrict:"E",replace:!0,scope:{response:"="},templateUrl:"/src/components/response/response.template.html",link:function(e,l,u){0!=e.response.parentId&&(e.response.parentValue=t.getResponsesClosureById(e.response.parentId,e.response.runId,o.activityId)),e.response.phase=o.phase,e.response.responseValueNew=e.response.responseValue,n.myDetails().then(function(t){e.myAccount=t}),r.getUserByAccount(e.response.runId,e.response.userEmail.split(":")[1]).then(function(t){e.user=t}),e.removeComment=function(e){swal({title:"Are you sure?",text:"You will not be able to recover it in the future!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, remove it!",closeOnConfirm:!1},function(){swal("Removed!","Your contribution has been removed from the inquiry","success"),t.deleteResponse(e.responseId)})},e.share=function(e){s.getRunById(e.runId).then(function(t){a.getActivityById(e.generalItemId,t.gameId).then(function(t){var n=document.querySelector("[ng-controller=InstantMessagingController]"),o=angular.element(n).scope();o.bodyMessage=t.name+"@"+r.getUserFromCache(e.userEmail.split(":")[1]).name+": "+e.responseValue})})},e.sendChildComment=function(r,a){n.myDetails().then(function(n){t.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:o.runId,deleted:!1,generalItemId:o.activityId,userEmail:n.accountType+":"+n.localId,responseValue:a,parentId:r.responseId,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(t){e.responseChildren=null,e.hiddenDiv=!1})})},e.gotoAnchor=function(e){var t=e;i.hash()!==t?i.hash(e):c()}}}}]).directive("ddTextCollapse",["$compile",function(e){return{restrict:"A",scope:!0,link:function(t,n,o){t.collapsed=!1,t.toggle=function(){t.collapsed=!t.collapsed},o.$observe("ddTextCollapseText",function(r){var a=t.$eval(o.ddTextCollapseMaxLength);if(r.length>a){var s=String(r).substring(0,a),i=String(r).substring(a,r.length),c=e("<span>"+s+"</span>")(t),l=e('<span ng-if="collapsed">'+i+"</span>")(t),u=e('<span ng-if="!collapsed">... </span>')(t),d=e('<br ng-if="collapsed">')(t),m=e('<span class="collapse-text-toggle" ng-click="toggle()">{{collapsed ? "less" : "more"}}</span>')(t);n.empty(),n.append(c),n.append(l),n.append(u),n.append(d),n.append(m)}else n.empty(),n.append(r)})}}}]),angular.module("DojoIBL").directive("responseQuestion",["$compile","ResponseService","AccountService","$stateParams","UserService","ActivityService","RunService",function(e,t,n,o,r,a,s){return{restrict:"E",replace:!0,scope:{response:"="},templateUrl:"/src/components/response/response.question.template.html",link:function(e,i,c){n.myDetails().then(function(t){e.myAccount=t}),r.getUserByAccount(e.response.runId,e.response.userEmail.split(":")[1]).then(function(t){e.user=t}),e.removeComment=function(e){swal({title:"Are you sure?",text:"You will not be able to recover it in the future!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, remove it!",closeOnConfirm:!1},function(){swal("Removed!","Your contribution has been removed from the inquiry","success"),t.deleteResponse(e.responseId)})},e.share=function(e){s.getRunById(e.runId).then(function(t){a.getActivityById(e.generalItemId,t.gameId).then(function(t){var n=document.querySelector("[ng-controller=InstantMessagingController]"),o=angular.element(n).scope();o.bodyMessage=t.name+"@"+r.getUserFromCache(e.userEmail.split(":")[1]).name+": "+e.responseValue})})},e.sendChildComment=function(r,a){n.myDetails().then(function(n){t.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:o.runId,deleted:!1,generalItemId:o.activityId,userEmail:n.accountType+":"+n.localId,responseValue:a,parentId:r.responseId,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(t){e.responseChildren=null})})},$("div[data-item='"+e.response.parentId+"']").parent().append(i)}}}]),angular.module("DojoIBL").directive("responses",function(){return{restrict:"E",replace:!0,scope:{responses:"="},template:"<response ng-repeat='response in responses | orderByDayNumber:\"lastModificationDate\"' response='response'></response>"}}),angular.module("DojoIBL").directive("item",["$compile","$parse","ResponseService","AccountService","$stateParams","UserService","ActivityService","$templateRequest","config",function(e,t,n,o,r,a,s,i,c){return{restrict:"E",replace:!0,scope:{response:"="},templateUrl:"/src/components/run/timeline.item.directive.html",link:function(e,t,n){if(e.response.responseValue.indexOf("{")==-1)e.extension="text",e.resource=e.response.responseValue;else{var o=JSON.parse(e.response.responseValue);o.documentUrl&&(e.type=o.fileType,e.name=o.fileName,e.extension="document",e.resource=o.documentUrl),o.excelUrl&&(e.type=o.fileType,e.name=o.fileName,e.extension="excel",e.resource=o.excelUrl),o.pdfUrl&&(e.type=o.fileType,e.name=o.fileName,e.extension="pdf",e.resource=o.pdfUrl),o.videoUrl&&(e.type=o.fileType,e.name=o.fileName,e.extension="video",e.resource=o.videoUrl),o.imageUrl&&(e.type=o.fileType,e.name=o.fileName,e.extension="image",e.resource=o.imageUrl),o.audioUrl&&(e.type=o.fileType,e.name=o.fileName,e.extension="audio",e.resource=o.audioUrl)}}}}]),angular.module("DojoIBL").service("AccountService",["$q","Account","CacheFactory",function(e,t,n){n("accountCache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});var o=n.get("accountCache"),r=(o.keys(),o.get("me"));return{myDetails:function(){var o=e.defer(),a=n.get("accountCache");return a.get("me")?o.resolve(a.get("me")):t.accountDetails().$promise.then(function(e){a.put("me",e),r=e,o.resolve(e)}),o.promise},myDetailsCache:function(){return r},accountDetailsById:function(o){var r=e.defer(),a=n.get("accountCache");return a.get(o)?r.resolve(a.get(o)):t.accountDetailsById({fullId:o}).$promise.then(function(e){console.log(e),a.put(o,e),r.resolve(e)}),r.promise},uploadUrl:function(e,n){return t.uploadUrl({account:e,key:n})},update:function(e){var n=this;t.update(e).$promise.then(function(e){n.refreshAccount(e.email)})},searchAccount:function(n){var o=e.defer();return t.search(n).$promise.then(function(e){o.resolve(e)}),o.promise},sendReminder:function(e){t.reminder({account:e})},refreshAccount:function(e){var t=n.get("accountCache");return t.get(e)&&t.remove(e),this.accountDetailsById(e)}}}]),angular.module("DojoIBL").service("ActivityService",["$q","Activity","CacheFactory",function(e,t,n){n("activitiesCache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"}),n("activitiesTempCache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});for(var o={},r={},a=n.get("activitiesCache"),s=a.keys(),i=0;i<s.length;i++){var c=a.get(s[i]);o[c.gameId]=o[c.gameId]||{},o[c.gameId][c.section]=o[c.gameId][c.section]||{},o[c.gameId][c.section][c.id]=c,r[c.gameId]=r[c.gameId]||[]}return{getActivitiesServer:function(a){var s=n.get("activitiesCache"),c=e.defer(),l=this;return t.getActivities({gameId:a}).$promise.then(function(e){for(i=0;i<e.generalItems.length;i++)if(!e.generalItems[i].deleted){angular.isUndefined(o[a])&&(o[a]={},r[a]=[]),angular.isUndefined(o[a][e.generalItems[i].section])&&(o[a][e.generalItems[i].section]={}),o[a][e.generalItems[i].section][e.generalItems[i].id]=e.generalItems[i];var t={_id:e.generalItems[i].id,title:e.generalItems[i].section+") "+e.generalItems[i].name,start:new Date(e.generalItems[i].timestamp),activity:e.generalItems[i]},n=l.arrayObjectIndexOf(r[a],e.generalItems[i].id,"_id");n==-1&&r[a].push(t),s.put(e.generalItems[i].id,e.generalItems[i])}c.resolve(e)}),c.promise},getActivities:function(){return console.log(o),o},getCalendarActivities:function(){return r},deleteActivity:function(e,a){var s=n.get("activitiesCache");s.remove(a.id);var i=this;delete o[e][a.section][a.id];var c=i.arrayObjectIndexOf(r[e],a.id,"_id");return c>-1&&r[e].splice(c,1),t.delete({gameId:e,itemId:a.id})},addRole:function(o,r,a){var s=e.defer(),i=n.get("activitiesCache");return t.addRole({generalItemId:o},r,a).$promise.then(function(e){i.put(o,e),s.resolve(e)}),s.promise},newActivity:function(e){Date.parse(e.timestamp)&&(e.timestamp=Date.parse(e.timestamp)),e.timeStamp=e.timestamp;var n=new t(e);return n.$save()},getActivityById:function(a,s){var i=e.defer(),c=this,l=n.get("activitiesCache");return l.get(a)?i.resolve(l.get(a)):t.getActivity({itemId:a,gameId:s}).$promise.then(function(e){if(!e.deleted&&!e.error){angular.isUndefined(o[s])&&(o[s]={}),angular.isUndefined(r[s])&&(r[s]=[]),angular.isUndefined(o[s][e.section])&&(o[s][e.section]={}),o[s][e.section][a]=e;var t={_id:e.id,title:e.section+") "+e.name,start:new Date(e.timestamp),activity:e},n=c.arrayObjectIndexOf(r[s],e.id,"_id");n==-1&&r[s].push(t),l.put(a,e),i.resolve(e)}}),i.promise},refreshActivity:function(e,t){var a=n.get("activitiesCache"),s=this,i=a.get(e);if(i){delete o[t][i.section][e];var c=({id:i.id,title:i.section+") "+i.name,start:new Date(i.timestamp),activity:i},s.arrayObjectIndexOf(r[t],i.id,"_id"));c>-1&&r[t].splice(c,1),a.remove(e)}return this.getActivityById(e,t)},uploadUrl:function(e,n,o){return t.uploadUrl({gameId:e,itemId:n,key:o})},arrayObjectIndexOf:function(e,t,n){for(var o=0,r=e.length;o<r;o++)if(e[o][n]===t)return o;return-1},getNextActivity:function(e,t,n){if(this.getLengthActivity(e,t,n)+1!=this.getCurrentPositionActivity(e,t,n)){var r=1+this.getCurrentPositionActivity(e,t,n);return o[t][n][Object.keys(o[t][n])[r]]}},getPrevActivity:function(e,t,n){if(this.getCurrentPositionActivity(e,t,n)>0){var r=this.getCurrentPositionActivity(e,t,n)-1;return o[t][n][Object.keys(o[t][n])[r]]}},getCurrentPositionActivity:function(e,t,n){return Object.keys(o[t][n]).indexOf(e)},getLengthActivity:function(e,t,n){return Object.keys(o[t][n]).length},getLengthPhase:function(e,t){return Object.keys(o[t]).length},saveActivityInCache:function(e){var t=n.get("activitiesTempCache");t.put("cachedActivity",e)},getActivityInCached:function(){var e=n.get("activitiesTempCache");return e.get("cachedActivity")},removeCachedActivity:function(){var e=n.get("activitiesTempCache");e.remove("cachedActivity")}}}]).service("ActivityStatusService",["$q","Activity","CacheFactory",function(e,t,n){n("activitiesStatusCache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});for(var o={},r=n.get("activitiesStatusCache"),a=r.keys(),s=0;s<a.length;s++){var i=r.get(a[s]);angular.isUndefined(o[i.runId])?o[i.runId]={}:o[i.runId]=o[i.runId],angular.isUndefined(o[i.runId][i.section])?o[i.runId][i.section]={}:o[i.runId][i.section]=o[i.runId][i.section],o[i.runId][i.section][i.id]=i}return{getActivitiesServerStatus:function(r,a,s){var i=n.get("activitiesStatusCache"),c=e.defer(),l=this;return t.getActivitiesForPhase({gameId:r,phase:s}).$promise.then(function(e){if(!e.error){for(var t=0;t<e.generalItems.length;t++){var n=e.generalItems[t];n.deleted?(angular.isUndefined(o[a])||angular.isUndefined(o[a][n.section])||delete o[a][n.section][n.id],i.remove(a+"_"+n.id)):(angular.isUndefined(o[a])&&(o[a]={}),angular.isUndefined(o[a][n.section])&&(o[a][n.section]={}),o[a][n.section][n.id]=n,o[a][n.section][n.id].runId=a)}c.resolve(e)}}).then(function(){angular.forEach(o[a][s],function(e){l.getActivityStatus(a,e.id).then(function(t){angular.isUndefined(t)?o[a][e.section][e.id].status=0:o[a][e.section][e.id].status=t,i.put(a+"_"+o[a][e.section][e.id].id,o[a][e.section][e.id])})})}),c.promise},getActivitiesStatus:function(){return o},refreshActivityStatus:function(e,t,r,a){var s=n.get("activitiesStatusCache");return s.get(r+"_"+e)&&(delete o[r][a][e],s.remove(r+"_"+e)),this.getActivityByIdRun(e,t,r)},changeActivityStatus:function(r,a,s,i){var c=e.defer(),l=n.get("activitiesStatusCache");return t.changeActivityStatus({runId:r,generalItemId:a,status:s}).$promise.then(function(e){o[r][i][a].status=e.status,l.put(r+"_"+o[r][i][a].id,o[r][i][a]),c.resolve(e)}),c.promise},getActivityStatus:function(o,r){var a=e.defer(),s=n.get("activitiesStatusCache");return s.get(o+"_"+r)?a.resolve(s.get(o+"_"+r).status):t.getActivityStatus({runId:o,generalItemId:r}).$promise.then(function(e){a.resolve(e.status)}),a.promise},getActivityByIdRun:function(r,a,s){var i,c=e.defer(),l=this,u=n.get("activitiesStatusCache");return u.get(s+"_"+r)?c.resolve(u.get(s+"_"+r)):t.getActivity({itemId:r,gameId:a}).$promise.then(function(e){e.error||(e.deleted?(angular.isUndefined(o[s])||angular.isUndefined(o[s][e.section])||delete o[s][e.section][r],u.remove(s+"_"+r)):(angular.isUndefined(o[s])&&(o[s]={}),angular.isUndefined(o[s][e.section])&&(o[s][e.section]={}),o[s][e.section][r]=e,o[s][e.section][r].runId=s,i=o[s][e.section][r])),c.resolve(i)}).then(function(){l.getActivityStatus(s,r).then(function(e){o[s][i.section][i.id].status=e,u.put(s+"_"+o[s][i.section][i.id].id,o[s][i.section][i.id])})}),c.promise}}}]),angular.module("DojoIBL").service("NotificationService",["$q","$sce","Game","CacheFactory","RunService","ActivityService",function(e,t,n,o,r,a){o("userNotificationsCache",{maxAge:2592e5,cacheFlushInterval:2592e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});var s=0;return{setNumberNotification:function(e){s=e;var t=o.get("userNotificationsCache");t.put("notifications",e)},getNumberNotification:function(){var e=o.get("userNotificationsCache");return e.get("notifications")?e.get("notifications"):0}}}]),angular.module("DojoIBL").constant("config",{server:""}),angular.module("DojoIBL").service("ChannelService",["$q","$http","CacheFactory","ChannelApi","$rootScope",function(e,t,n,o,r){n("channelAPICache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});var a=n.get("channelAPICache"),s=function(){this.messageCallback=function(){},this.onMessage=function(e){var t=function(t){e(JSON.parse(t.data))};void 0==this.channelSocket?this.messageCallback=t:this.channelSocket.onmessage=t};var e=this;this.socketCreationCallback=function(t){var n=new goog.appengine.Channel(t.token);a.put("tokenChannelApi",t),e.channelId=t.channelId;var o=n.open();o.onerror=function(){console.log("Channel error")},o.onclose=function(){console.log("Channel closed, reopening"),e.messageCallback=e.channelSocket.onmessage,e.channelSocket=void 0,$.getJSON("chats/channel",e.socketCreationCallback),a.remove("tokenChannelApi"),swal({title:"Timeout!",text:"The session has timed out. Refresh!",type:"warning",showCancelButton:!1,confirmButtonColor:"#DD6B55",confirmButtonText:"Refresh!!",closeOnConfirm:!1},function(){location.reload()})},e.channelSocket=o,e.channelSocket.onmessage=e.messageCallback},o.getToken().$promise.then(this.socketCreationCallback)},i={},c=new s;return c.onMessage(function(e){r.$apply(function(){console.info(e.type),i[e.type]&&i[e.type](e)})}),{register:function(e,t){i[e]=t}}}]),angular.module("DojoIBL").service("GameService",["$q","$sce","Game","CacheFactory","RunService","ActivityService",function(e,t,n,o,r,a){o("gamesCache",{maxAge:864e5,cacheFlushInterval:432e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});for(var s={},i=o.get("gamesCache"),c=i.keys(),l=0;l<c.length;l++)s[c[l]]=i.get(c[l]);var u,d,m=0;return{resumeLoadingGames:function(){var r=e.defer(),a=o.get("gamesCache"),i=this;return n.resume({resumptionToken:u,from:m}).$promise.then(function(e){if(e.error)r.resolve(e);else{for(l=0;l<e.games.length;l++)e.games[l].deleted?delete s[e.games[l].gameId]:(a.put(e.games[l].gameId,e.games[l]),s[e.games[l].gameId]=e.games[l],s[e.games[l].gameId].description=t.trustAsHtml(e.games[l].description),s[e.games[l].gameId].access={},i.getGameAccesses(e.games[l].gameId).then(function(e){angular.forEach(e.gamesAccess,function(e){s[e.gameId].access[e.account]=e})}));u=e.resumptionToken,d=d||e.serverTime,e.resumptionToken||(m=d,d=void 0),r.resolve(e)}}),r.promise},getGameById:function(t){var r=e.defer(),a=this,i=o.get("gamesCache");return i.get(t)?r.resolve(i.get(t)):n.getGameById({id:t}).$promise.then(function(e){if(!e.error)if(e.deleted)delete s[t],i.remove(t);else{var n=[];angular.forEach(e.config.roles,function(e){n.push(JSON.parse(e))}),e.config.roles=n,i.put(t,e),s[t]=e,s[t].access={},a.getGameAccesses(t).then(function(e){angular.forEach(e.gamesAccess,function(e){s[e.gameId].access[e.account]=e})})}r.resolve(e)}),r.promise},refreshGame:function(e){var t=o.get("gamesCache");return t.get(e)&&(delete s[e],t.remove(e)),this.getGameById(e)},getGameFromCache:function(e){var t=o.get("gamesCache");return t.get(e)},storeInCache:function(e){var t=o.get("gamesCache");t.put(e.gameId,e)},newGame:function(e){var t=o.get("gamesCache");e.gameId&&t.put(e.gameId,e);var r=new n(e);return r.$save()},giveAccess:function(e,t,o){n.giveAccess({gameId:e,accountId:t,accessRight:o})},getGameAccesses:function(t){var o=e.defer();return n.getGameAccesses({gameId:t}).$promise.then(function(e){o.resolve(e)}),o.promise},getGames:function(){return s},deleteGame:function(e){var t=o.get("gamesCache");return t.remove(e),delete s[e],n.deleteGame({gameId:e})},removePhase:function(e,t){e.phases.splice(t,1),this.newGame(e).then(function(t){r.getParticipateRunsForGame(e.gameId).then(function(e){angular.forEach(e,function(e,n){e.game=t,r.storeInCache(e)})})}),a.getActivitiesForPhase(e.gameId,t).then(function(e){angular.forEach(e,function(e,t){a.deleteActivity(e.gameId,e.id)})})},addRole:function(t,r,a){var s=e.defer(),i=o.get("gamesCache");return n.addRole({gameId:t},r,a).$promise.then(function(e){i.put(t,e),s.resolve(e)}),s.promise},removeRole:function(t,r){var a=e.defer(),s=o.get("gamesCache");return n.removeRole({gameId:t},r).$promise.then(function(e){s.put(t,e),a.resolve(e)}),a.promise},editRole:function(t,r,a){var s=e.defer(),i=o.get("gamesCache");return n.editRole({gameId:t,index:a},r).$promise.then(function(e){i.put(t,e),s.resolve(e)}),s.promise},cloneInquiry:function(e,t){var n=this;this.getGameById(e).then(function(o){var r={};r.title=t,r.phases=o.phases,r.description=o.description,n.newGame(r).then(function(t){a.getActivitiesServer(e).then(function(e){angular.forEach(e.generalItems,function(e){if(!e.deleted){var n={type:e.type,section:e.section,gameId:t.gameId,deleted:e.deleted,name:e.name,description:e.description,autoLaunch:e.autoLaunch,fileReferences:e.fileReferences,sortKey:e.sortKey,richText:e.richText};"org.celstec.arlearn2.beans.generalItem.VideoObject"==e.type?n.videoFeed=e.videoFeed:"org.celstec.arlearn2.beans.generalItem.AudioObject"==e.type&&(n.audioFeed=e.audioFeed),a.newActivity(n)}})})})})},getGameAssets:function(t){var o=e.defer();return n.gameAssets({gameId:t}).$promise.then(function(e){o.resolve(e.gameFiles)}),o.promise}}}]),angular.module("DojoIBL").service("MessageService",["$q","Message","CacheFactory","UserService",function(e,t,n,o){n("messagesCache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});for(var r={},a=n.get("messagesCache"),s=a.keys(),i=0;i<s.length;i++){var c=a.get(s[i]);r[c.runId]=r[c.runId]||{},r[c.runId][c.messageId]=c}return{getMessagesDefaultByRun:function(e){return r[e]},newMessage:function(e){var o=new t(e);n.get("messagesCache");return o.$save()},refreshMessage:function(e,t){var o=n.get("messagesCache");return o.get(t)&&(delete r[e][t],o.remove(t)),this.getMessageById(t)},getMessages:function(a,s,c){var l=e.defer(),u=n.get("messagesCache");r[a]=r[a]||{},s||(s=0);var d=this;return c?t.resume({runId:a,resumptionToken:c,from:s}).$promise.then(function(e){if(e.error)l.resolve(e);else{for(i=0;i<e.messages.length;i++)if(e.messages[i].deleted)delete r[a][e.messages[i].messageId];else{u.put(e.messages[i].messageId,e.messages[i]),r[a][e.messages[i].messageId]=e.messages[i];var t=e.messages[i];r[a][t.messageId].user=o.getUser(a,e.messages[i].senderProviderId+":"+e.messages[i].senderId)}e.resumptionToken&&d.getMessages(a,s,e.resumptionToken)}}):t.resume({runId:a,from:0}).$promise.then(function(e){if(e.error)l.resolve(e);else{for(var t=0;t<e.messages.length;t++)if(e.messages[t].deleted)delete r[a][e.messages[t].messageId];else{u.put(e.messages[t].messageId,e.messages[t]),r[a][e.messages[t].messageId]=e.messages[t];var n=e.messages[t];r[a][n.messageId].user=o.getUser(a,e.messages[t].senderProviderId+":"+e.messages[t].senderId)}e.resumptionToken&&d.getMessages(a,s,e.resumptionToken)}}),r[a]},getMessageById:function(a){var s=e.defer(),i=n.get("messagesCache");return i.get(a)?s.resolve(i.get(a)):t.getMessageById({messageId:a}).$promise.then(function(e){i.put(a,e),r[e.runId][e.messageId]=e,r[e.runId][e.messageId].user=o.getUser(e.runId,e.senderProviderId+":"+e.senderId),s.resolve(e)}),s.promise}}}]),angular.module("DojoIBL").factory("Session",["$http","CacheFactory",function(e,t){function n(e){var t="; "+document.cookie,n=t.split("; "+e+"=");if(2==n.length)return n.pop().split(";").shift()}return{getOauthType:function(){return n("arlearn.OauthType")&&this.setOauthType(n("arlearn.OauthType")),localStorage.getItem("oauth")},setOauthType:function(e){return localStorage.setItem("oauth",e)},getAccessToken:function(){var e=this;return n("arlearn.AccessToken")&&e.setAccessToken(n("arlearn.AccessToken")),localStorage.getItem("accessToken")},setAccessToken:function(t){return e.defaults.headers.common.Authorization="GoogleLogin auth="+t,localStorage.setItem("accessToken",t)},reset:function(){var e=t.get("accountCache"),n=t.get("activitiesCache"),o=t.get("activitiesStatusCache"),r=t.get("gamesCache"),a=t.get("responsesCache"),s=t.get("runsCache"),i=t.get("usersCache"),c=t.get("messagesCache");e&&e.removeAll(),n&&n.removeAll(),o&&o.removeAll(),r&&r.removeAll(),a&&a.removeAll(),s&&s.removeAll(),i&&i.removeAll(),c&&c.removeAll(),localStorage.removeItem("oauth"),localStorage.removeItem("accessToken")}}}]),angular.module("DojoIBL").service("ResponseService",["$q","Response","CacheFactory","UserService","$filter",function(e,t,n,o,r){n("responsesCache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"}),n("responsesTempCache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});for(var a={},s=n.get("responsesCache"),i=s.keys(),c=0;c<i.length;c++){var l=s.get(i[c]);a[l.runId+"_"+l.generalItemId]=a[l.runId+"_"+l.generalItemId]||{},a[l.runId+"_"+l.generalItemId][l.responseId]=l}var u,d,m=0;return{newResponse:function(e){var n=new t(e);return n.$save()},deleteResponse:function(o){var r=e.defer(),s=n.get("responsesCache");return s.remove(o),t.deleteResponse({responseId:o}).$promise.then(function(e){r.resolve(e),delete a[e.runId+"_"+e.generalItemId][e.responseId]}),r.promise},getResponsesByInquiryActivity:function(e,t){return a[e+"_"+t]},getResponsesClosureById:function(e,t,n){return a[t+"_"+n][e]},addResponse:function(e,t,r){var s=n.get("responsesCache");angular.isUndefined(a[t+"_"+r])&&(a[t+"_"+r]={}),a[t+"_"+r][e.responseId]=e,a[t+"_"+r][e.responseId].user=o.getUser(t,e.userEmail),s.put(e.responseId,a[t+"_"+r][e.responseId]);
},refreshResponse:function(e,t,o){var r=n.get("responsesCache");return r.get(e.responseId)&&(delete a[t+"_"+o][e.responseId],r.remove(e.responseId)),this.getResponseById(e.responseId,t,o)},getResponseById:function(r,s,i){var c=e.defer(),l=n.get("responsesCache");return l.get(r)?c.resolve(l.get(r)):t.getResponse({id:r}).$promise.then(function(e){e.error||(e.deleted?(delete a[s+"_"+i][r],l.remove(r)):(angular.isUndefined(a[s+"_"+i])&&(a[s+"_"+i]={}),angular.isUndefined(a[s+"_"+i][r])&&(a[s+"_"+i][r]={}),a[s+"_"+i][r]=e,a[s+"_"+i][r].user=o.getUser(s,e.userEmail),l.put(r,a[s+"_"+i][r]))),c.resolve(e)}),c.promise},getResponses:function(r,s){var i=e.defer(),l=n.get("responsesCache");a[r+"_"+s]=a[r+"_"+s]||{},m||(m=0);var d=this;return u?t.getResponsesInquiryActivity({runId:r,itemId:s,resumptionToken:u,from:m}).$promise.then(function(e){if(e.error)i.resolve(e);else{for(c=0;c<e.responses.length;c++)e.responses[c].deleted?delete[r+"_"+s][e.responses[c].responseId]:(l.put(e.responses[c].responseId,e.responses[c]),a[r+"_"+s][e.responses[c].responseId]=e.responses[c],a[r+"_"+s][e.responses[c].responseId].user=o.getUser(r,e.responses[c].userEmail));e.resumptionToken&&d.getResponses(r,s,m,e.resumptionToken)}}):t.getResponsesInquiryActivity({runId:r,itemId:s,serverTime:0}).$promise.then(function(e){if(e.error)i.resolve(e);else{for(c=0;c<e.responses.length;c++)e.responses[c].deleted?delete[r+"_"+s][e.responses[c].responseId]:(l.put(e.responses[c].responseId,e.responses[c]),a[r+"_"+s][e.responses[c].responseId]=e.responses[c],a[r+"_"+s][e.responses[c].responseId].user=o.getUser(r,e.responses[c].userEmail));e.resumptionToken&&d.getResponses(r,s,m,e.resumptionToken)}}),a[r+"_"+s]},uploadUrl:function(e,n,o){return t.uploadUrl({runId:e,account:n,key:o})},resumeLoadingResponses:function(r,s){var i=e.defer(),l=n.get("responsesCache");return a[r+"_"+s]=a[r+"_"+s]||{},m=l.get(r+"_"+s)?l.get(r+"_"+s):0,t.getResponsesInquiryActivity({runId:r,itemId:s,resumptionToken:u,from:0}).$promise.then(function(e){if(e.error)i.resolve(e);else{for(c=0;c<e.responses.length;c++)e.responses[c].deleted?delete[r+"_"+s][e.responses[c].responseId]:(angular.isUndefined(a[r+"_"+s])&&(a[r+"_"+s]={}),a[r+"_"+s][e.responses[c].responseId]=e.responses[c],a[r+"_"+s][e.responses[c].responseId].user=o.getUser(r,e.responses[c].userEmail),l.put(e.responses[c].responseId,a[r+"_"+s][e.responses[c].responseId]));u=e.resumptionToken,d=d||e.serverTime,l.put(r+"_"+s,d),e.resumptionToken||(m=d,d=void 0),i.resolve(e)}}),i.promise},saveResponseInCache:function(e,t){var o=n.get("responsesTempCache");o.put("cachedResponse"+t,e)},getResponseInCached:function(e){var t=n.get("responsesTempCache");return t.get("cachedResponse"+e)},removeCachedResponse:function(e){var t=n.get("responsesTempCache");t.remove("cachedResponse"+e)}}}]),angular.module("DojoIBL").service("UserService",["$q","User","CacheFactory","AccountService","toaster","$location","$stateParams",function(e,t,n,o,r,a,s){n("usersCache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"});for(var i={},c=n.get("usersCache"),l=c.keys(),u=0;u<l.length;u++){var d=c.get(l[u]);i[d.runId]=i[d.runId]||{},i[d.runId][d.accountType+":"+d.localId]=d}return{getUsersForRun:function(o){var r=(n.get("usersCache"),e.defer());return i[o]=i[o]||{},t.getUsersRun({id:o}).$promise.then(function(e){var t=[];angular.forEach(e.users,function(e){e.deleted||(e.runId=o,i[o][e.accountType+":"+e.localId]=e,t.push(e))}),r.resolve(t)}),r.promise},getUserFromCache:function(e){var t=n.get("usersCache");return t.get(e)},getUser:function(e,t){return i[e][t]},getUserByAccount:function(o,r){var a=e.defer(),s=n.get("usersCache");return s.get(r)?a.resolve(s.get(r)):t.getUserByAccount({runId:o,accountId:r}).$promise.then(function(e){e.deleted?(delete i[o][e.accountType+":"+e.localId],s.remove(r)):(angular.isUndefined(i[o])&&(i[o]={}),e.runId=o,s.put(r,e),i[o][e.accountType+":"+e.localId]=e,a.resolve(e))}),a.promise},checkAccess:function(){function e(e,t,n){for(var o=0,r=e.length;o<r;o++)if(e[o][n]===t)return o;return-1}var t=s.runId,n=this;o.myDetails().then(function(o){console.log(t,o),n.getUsersForRun(t).then(function(t){console.log(e(t,o.localId,"localId")),e(t,o.localId,"localId")==-1&&(a.path("home"),r.error({title:"No access ",body:"You do not have access to this inquiry."}))})})}}}]),angular.module("DojoIBL").service("RunService",["$q","Run","CacheFactory",function(e,t,n){return n("runsCache",{maxAge:864e5,cacheFlushInterval:36e5,deleteOnExpire:"aggressive",storageMode:"localStorage"}),{getRunById:function(o){var r=e.defer(),a=n.get("runsCache");return a.get(o)?r.resolve(a.get(o)):t.getRun({id:o}).$promise.then(function(e){if(!angular.isUndefined(e.game.config.roles)){for(var t=[],n=0;n<e.game.config.roles.length;n++)t.push(JSON.parse(e.game.config.roles[n]));e.game.config.roles=t}a.put(o,e),r.resolve(e)}),r.promise},getRunByCode:function(n){var o=e.defer();return t.getRunByCode({code:n}).$promise.then(function(e){o.resolve(e)}),o.promise},getOwnedRunsForGame:function(n){var o=this,r=e.defer();return t.getOwnedRunsForGame({id:n}).$promise.then(function(e){for(var t={},n=0;n<e.runAccess.length;n++)t["id"+e.runAccess[n].runId]=e.runAccess[n],o.getRunById(e.runAccess[n].runId).then(function(e){t["id"+e.runId].run=e});r.resolve(e)}),r.promise},getParticipateRunsForGame:function(o){var r=n.get("runsCache"),a=e.defer();return t.getParticipateRunsForGame({id:o}).$promise.then(function(e){for(var t={},n=0;n<e.runs.length;n++)e.runs[n].deleted||(r.put(e.runs[n].runId,e.runs[n]),t["id"+e.runs[n].runId]=e.runs[n]);a.resolve(t)}),a.promise},newRun:function(e){var o=new t(e),r=n.get("runsCache");return e.runId&&r.put(e.runId,e),o.$save()},updateRun:function(e){t.update({runId:e.runId},e)},giveAccess:function(e,n,o){t.giveAccess({runId:e,accountId:n,accessRight:o})},removeAccessToInquiryRun:function(e,n){t.removeAccess({runId:e,accountId:n.accountType+":"+n.localId}),t.removeUserRun({runId:e,email:n.accountType+":"+n.localId})},addUserToRun:function(e){return t.addUserToRun(e)},deleteRun:function(e){var o=n.get("runsCache");return o.remove(e),t.delete({id:e})},storeInCache:function(e){var t=n.get("runsCache");t.get(e.runId)&&t.remove(e.runId),t.put(e.runId,e)}}}]),angular.module("DojoIBL").controller("ProfileController",["$scope","$sce","$stateParams","$state","Session","AccountService","Upload","config",function(e,t,n,o,r,a,s,i){a.myDetails().then(function(t){e.myAccount=t,e.nameValue=e.myAccount.familyName+" "+e.myAccount.givenName}),a.accountDetailsById(n.fullId).then(function(t){e.user=t}),e.ok=function(){console.log(e.user),a.update({type:"org.celstec.arlearn2.beans.account.Account",accountType:e.myAccount.accountType,localId:e.myAccount.localId,email:e.myAccount.accountType+":"+e.myAccount.localId,picture:e.myAccount.picture,name:e.user.name})},e.upload=function(t){e.progressPercentage=0,a.uploadUrl(e.myAccount.accountType+":"+e.myAccount.localId,t.name).$promise.then(function(n){console.log(n),s.upload({url:n.uploadUrl,data:{file:t,username:e.username}}).then(function(t){a.update({type:"org.celstec.arlearn2.beans.account.Account",accountType:e.myAccount.accountType,localId:e.myAccount.localId,email:e.myAccount.accountType+":"+e.myAccount.localId,name:e.myAccount.familyName+" "+e.myAccount.givenName,picture:i.server+"/uploadUserContent/"+t.config.data.file.name+"?account="+e.myAccount.accountType+":"+e.myAccount.localId}),console.log(t),console.log("Success "+t.config.data.file.name+"uploaded. Response: "+t.data)},function(e){console.log("Error status: "+e.status)},function(t){var n=parseInt(100*t.loaded/t.total);e.progressPercentage=n,console.log("progress: "+n+"% "+t.config.data.file.name)})})}}]),angular.module("DojoIBL").controller("ProfilesController",["$scope","$sce","$stateParams","$state","Session","AccountService",function(e,t,n,o,r,a){a.myDetails().then(function(t){e.user=t})}]),angular.module("DojoIBL").controller("ActivityController",["$scope","$sce","$stateParams","Session","ActivityService","UserService","AccountService","Response","ResponseService","RunService","ChannelService","Upload","config","toaster","GameService",function(e,t,n,o,r,a,s,i,c,l,u,d,m,g,p){function f(){c.resumeLoadingResponses(n.runId,n.activityId).then(function(t){t.error?e.showNoAccess=!0:(e.show=!0,t.resumptionToken&&f())})}u.register("org.celstec.arlearn2.beans.run.Response",function(e){console.log(e),n.activityId==e.generalItemId&&n.runId==e.runId&&c.refreshResponse(e,n.runId,n.activityId),n.runId==e.runId&&g.success({title:a.getUser(n.runId,e.userEmail).name+" added a response",body:a.getUser(n.runId,e.userEmail).name+" has contributed to an activity."})}),u.register("org.celstec.arlearn2.beans.notification.GeneralItemModification",function(t){r.refreshActivity(t.itemId,t.gameId).then(function(t){e.activity=t}),g.success({title:"Activity modified",body:"The structure of the activity has been modified."})}),e.responses={},e.loadMoreButton=!1,f(),e.responses=c.getResponsesByInquiryActivity(n.runId,n.activityId),l.getRunById(n.runId).then(function(t){r.getActivityById(n.activityId,t.game.gameId).then(function(t){e.activity=t}),p.getGameAssets(t.game.gameId).then(function(t){e.assets=t})}),s.myDetails().then(function(t){e.myAccount=t}),e.sendComment=function(){null!=e.response&&e.response.length>0&&(angular.isUndefined(e.response.id)&&c.removeCachedResponse(n.activityId),s.myDetails().then(function(t){c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:t.accountType+":"+t.localId,responseValue:e.response,parentId:0,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(t){e.response=null})}))},e.sendChildComment=function(t,o){s.myDetails().then(function(r){c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:r.accountType+":"+r.localId,responseValue:o,parentId:t.responseId,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(t){e.responseChildren=null})})},e.removeComment=function(e){swal({title:"Are you sure?",text:"You will not be able to recover it in the future!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, remove it!",closeOnConfirm:!1},function(){swal("Removed!","Your contribution has been removed from the inquiry","success"),c.deleteResponse(e.responseId)})},e.trustSrc=function(e){return t.trustAsResourceUrl(e)},c.getResponseInCached(n.activityId)&&(e.response=c.getResponseInCached(n.activityId)),e.saveResponse=function(){null!=e.response&&e.response.length>0&&(angular.isUndefined(e.response.id)?c.saveResponseInCache(e.response,n.activityId):c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:data.accountType+":"+data.localId,responseValue:e.response,parentId:0,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(t){e.response=null}))},e.upload=function(t){e.progressPercentage=0,t&&(t.name=t.name.replace(/\s+/g,"_"),c.uploadUrl(n.runId,e.myAccount.accountType+":"+e.myAccount.localId,t.name.replace(/\s+/g,"_")).$promise.then(function(o){console.log(o,o.uploadUrl),d.rename(t,t.name.replace(/\s+/g,"_")),d.upload({url:o.uploadUrl,data:{file:t,username:e.myAccount.accountType+":"+e.myAccount.localId}}).then(function(o){switch(!0){case/video/.test(o.config.data.file.type):c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:e.myAccount.accountType+":"+e.myAccount.localId,responseValue:{videoUrl:m.server+"/uploadService/"+n.runId+"/"+e.myAccount.accountType+":"+e.myAccount.localId+"/"+t.name.replace(/\s+/g,"_"),fileName:t.name,fileType:o.config.data.file.type,width:3264,height:1840},parentId:0,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(e){});break;case/image/.test(o.config.data.file.type):c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:e.myAccount.accountType+":"+e.myAccount.localId,responseValue:{imageUrl:m.server+"/uploadService/"+n.runId+"/"+e.myAccount.accountType+":"+e.myAccount.localId+"/"+t.name.replace(/\s+/g,"_"),fileName:t.name,fileType:o.config.data.file.type,width:3264,height:1840},parentId:0,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(e){});break;case/pdf/.test(o.config.data.file.type):c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:e.myAccount.accountType+":"+e.myAccount.localId,responseValue:{pdfUrl:m.server+"/uploadService/"+n.runId+"/"+e.myAccount.accountType+":"+e.myAccount.localId+"/"+t.name.replace(/\s+/g,"_"),fileName:t.name,fileType:o.config.data.file.type,width:3264,height:1840},parentId:0,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(e){});break;case/audio/.test(o.config.data.file.type):c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:e.myAccount.accountType+":"+e.myAccount.localId,responseValue:{audioUrl:m.server+"/uploadService/"+n.runId+"/"+e.myAccount.accountType+":"+e.myAccount.localId+"/"+t.name.replace(/\s+/g,"_"),fileName:t.name,fileType:o.config.data.file.type,width:3264,height:1840},parentId:0,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(e){});break;case/wordprocessingml|msword/.test(o.config.data.file.type):console.log(o.config.data.file.type),c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:e.myAccount.accountType+":"+e.myAccount.localId,responseValue:{documentUrl:m.server+"/uploadService/"+n.runId+"/"+e.myAccount.accountType+":"+e.myAccount.localId+"/"+t.name.replace(/\s+/g,"_"),fileName:t.name,fileType:o.config.data.file.type,width:3264,height:1840},parentId:0,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(e){});break;case/vnd.ms-excel|spreadsheetml/.test(o.config.data.file.type):console.log(o.config.data.file.type),c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:e.myAccount.accountType+":"+e.myAccount.localId,responseValue:{excelUrl:m.server+"/uploadService/"+n.runId+"/"+e.myAccount.accountType+":"+e.myAccount.localId+"/"+t.name.replace(/\s+/g,"_"),fileName:t.name,fileType:o.config.data.file.type,width:3264,height:1840},parentId:0,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(e){});break;default:c.newResponse({type:"org.celstec.arlearn2.beans.run.Response",runId:n.runId,deleted:!1,generalItemId:n.activityId,userEmail:e.myAccount.accountType+":"+e.myAccount.localId,responseValue:t.name,parentId:0,revoked:!1,lastModificationDate:(new Date).getTime()}).then(function(e){})}console.log(o),console.log("Success "+o.config.data.file.name+" uploaded by: "+o.config.data.username)},function(e){console.log(e),console.log("Error "+e.config.data.file.name+" from: "+e.config.data.username),console.log("Error status: "+e.status)},function(t){var n=parseInt(100*t.loaded/t.total);e.progressPercentage=n,console.log("progress: "+n+"% "+t.config.data.file.name)})}))},e.getUser=function(e){return a.getUserFromCache(e.userEmail.split(":")[1]).name},e.getAvatar=function(e){return a.getUserFromCache(e.userEmail.split(":")[1]).picture},e.getRoleColor=function(e){if(!angular.isUndefined(e))try{if(!angular.isUndefined(angular.fromJson(e[0]))&&!angular.isObject(e[0]))return{color:angular.fromJson(e[0]).color}}catch(e){return{color:"#f8ac59"}}return{color:"#f8ac59"}},e.trustSrc=function(e){return t.trustAsResourceUrl(e)}}]),angular.module("DojoIBL").controller("PhaseController",["$scope","$sce","$location","$stateParams","$state","toaster","Session","ActivityStatusService","RunService","ChannelService",function(e,t,n,o,r,a,s,i,c,l){e.runId=o.runId,l.register("org.celstec.arlearn2.beans.run.GeneralItemsStatus",function(t){i.refreshActivityStatus(t.generalItemId,e.gameId,o.runId,o.phase),a.success({title:"Activity modified",body:"The structure of the activity has been modified."})}),e.phase="holaaaaaaa",c.getRunById(o.runId).then(function(t){e.phase=t.game.phases[o.phase],e.phase.num=o.phase,e.gameId=t.game.gameId,i.getActivitiesServerStatus(t.game.gameId,o.runId,o.phase)}),e.activities=i.getActivitiesStatus(),e.sortableOptions={connectWith:".connectList",scroll:!1,receive:function(e,t){var n=t.item.scope().activity,r=e.target;i.changeActivityStatus(o.runId,n.id,r.id,o.phase).then(function(e){switch(e.status){case 0:a.success({title:"Moved to ToDo list",body:"The activity has been successfully moved to the ToDo list."});break;case 1:a.success({title:"Moved to In Progress list",body:"The activity has been successfully moved to the In Progress list."});break;case 2:a.success({title:"Moved to Completed list",body:"The activity has been successfully moved to the Completed list."})}})},"ui-floating":"auto",start:function(t,n){e.sortableFirst&&(e.wscrolltop=$(window).scrollTop()),e.sortableFirst=!0},sort:function(t,n){n.helper.css({top:n.position.top+e.wscrolltop+"px"})}},e.goToActivity=function(e,t,o){n.path("inquiry/"+e+"/phase/"+t+"/activity/"+o)},e.getRoleName=function(e){if(!angular.isUndefined(e))try{if(!angular.isUndefined(e[0]))return e[0].name}catch(e){return"-"}return"-"},e.getRoleColor=function(e){if(!angular.isUndefined(e))try{if(!angular.isUndefined(e[0]))return{"border-left":"3px solid "+e[0].color}}catch(e){return{"border-left":"3px solid #2f4050"}}return{"border-left":"3px solid #2f4050"}}}]),angular.module("DojoIBL").controller("FooterController",["$scope","Session",function(e,t){e.test="foo",e.name="your name",t.getAccessToken()}]),angular.module("DojoIBL").controller("HeaderController",["$scope","Session","$translate","$state","$location","config",function(e,t,n,o,r,a){e.test="foo",e.name="your name",e.flags=[{icon:"src/assets/img/i18n/Spain.png",name:"Spanish",id:"es"},{icon:"src/assets/img/i18n/United-States.png",name:"English",id:"en"},{icon:"src/assets/img/i18n/Netherlands.png",name:"Dutch",id:"nl"}],t.getAccessToken(),e.setLanguage=function(e){n.use(e)},e.signout=function(){t.reset(),document.cookie="arlearn.AccessToken=; expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/",window.location.href=a.server+"/index.html"}}]),angular.module("DojoIBL").controller("SidebarController",["$scope","$rootScope","$modal","Session","$state","$stateParams","GameService","RunService","Account","AccountService",function(e,t,n,o,r,a,s,i,c,l){e.$on("$stateChangeSuccess",function(){e.phaseNumber=r.params.phase,e.statePhase=r.current.name}),e.$on("inquiry-run",function(t,n){i.getRunById(n.runId).then(function(t){e.run=t,l.myDetails()})}),a.runId?i.getRunById(a.runId).then(function(t){e.run=t,l.myDetails()}):a.gameId?s.getGameById(a.gameId).then(function(t){t.error?e.showNoAccess=!0:e.show=!0,e.game=t}):l.myDetails(),e.myAccount=l.myDetailsCache(),e.createNewInquiry=function(){n.open({templateUrl:"/src/components/common/new.inquiry.modal.html",controller:"NewInqCtrl"})}}]).controller("NewInqCtrl",["$scope","$modalInstance","GameService","ActivityService",function(e,t,n,o){e.ok=function(){e.game.deleted=!1,e.game.revoked=!1;var o=["Problem statement","Plan the method","Collect the data","Analyse the data","Interpret the findings","Communicate the results"];e.game.template&&(e.game.phases=[],angular.forEach(o,function(t){e.game.phases.push({title:t,type:"org.celstec.arlearn2.beans.game.Phase"})})),n.newGame(e.game).then(function(t){e.game=t,e.game.config.roles=[]}),t.close()},e.cancel=function(){t.dismiss("cancel")}}]),angular.module("DojoIBL").controller("ToolbarController",["$scope","$rootScope","$state","$location","$stateParams","RunService","ActivityService","Session","Game","GameService","AccountService","config","ChannelService","UserService",function(e,t,n,o,r,a,s,i,c,l,u,d,m,g){e.test="foo",e.name="your name",e.inquiryCode,e.leftDisabled=!1,e.state=n,r.runId&&(e.$on("inquiry-run",function(t,n){a.getRunById(n.runId).then(function(t){e.run=t})}),a.getRunById(r.runId).then(function(o){e.run=o,c.access({}).$promise.then(function(t){angular.forEach(t.gamesAccess,function(t){o.gameId==t.gameId&&l.getGameById(t.gameId).then(function(n){var o=angular.extend({},n,t);e.game=o,r.phase&&(e.namePhase=n.phases[r.phase])})})}),a.getParticipateRunsForGame(o.gameId).then(function(t){var n=[];e.itemArray=n,angular.forEach(t,function(e){n.push(e)}),e.selected={value:e.itemArray[0]}}),e.selectChange=function(e){switch(t.$broadcast("inquiry-run",{runId:e.runId}),n.current.name){case"inquiry.home":n.go("inquiry.home",{runId:e.runId});break;case"inquiry.timeline":n.go("inquiry.timeline",{runId:e.runId});break;case"inquiry.phase":n.go("inquiry.phase",{runId:e.runId,phase:n.params.phase});break;case"inquiry.activity":n.go("inquiry.activity",{runId:e.runId,phase:n.params.phase,activityId:n.params.activityId})}},r.activityId&&s.getActivityById(r.activityId,o.gameId).then(function(t){e.activity=t}),e.goLeft=function(){switch(n.current.name){case"inquiry.home":break;case"inquiry.phase":if(n.params.phase>0){var e=n.params.phase-1;n.go("inquiry.phase",{runId:o.runId,phase:e})}break;case"inquiry.activity":var t=s.getPrevActivity(r.activityId,o.gameId,n.params.phase);angular.isUndefined(t)||n.go("inquiry.activity",{runId:o.runId,phase:n.params.phase,activityId:t.id})}},e.goUp=function(){switch(n.current.name){case"inquiry.home":n.go("home",{});break;case"inquiry.phase":n.go("inquiry.home",{runId:o.runId});break;case"inquiry.activity":n.go("inquiry.phase",{runId:o.runId,phase:n.params.phase})}},e.goRight=function(){switch(n.current.name){case"inquiry.home":break;case"inquiry.phase":if(n.params.phase<s.getLengthPhase(r.activityId,o.gameId)-1){var e=parseInt(n.params.phase)+1;n.go("inquiry.phase",{runId:o.runId,phase:e})}break;case"inquiry.activity":var t=s.getNextActivity(r.activityId,o.gameId,n.params.phase);angular.isUndefined(t)||n.go("inquiry.activity",{runId:o.runId,phase:n.params.phase,activityId:t.id})}}})),e.findAndJoin=function(){a.getRunByCode(e.inquiryCode).then(function(e){u.myDetails().then(function(t){console.log(t),l.giveAccess(e.game.gameId,t.accountType+":"+t.localId,2),a.giveAccess(e.runId,t.accountType+":"+t.localId,2),a.addUserToRun({runId:e.runId,email:t.accountType+":"+t.localId,accountType:t.accountType,localId:t.localId,gameId:e.game.gameId}),window.location.href=d.server+"/main.html#/inquiry/"+e.runId})}),e.inquiryCode=null},m.register("org.celstec.arlearn2.beans.run.User",function(e){console.info("[Notification][User]",e),g.getUserByAccount(e.runId,e.accountType+":"+e.localId)})}]),angular.module("DojoIBL").controller("InquiryEditGameController",["$scope","$sce","$stateParams","$state","$modal","Session","RunService","ActivityService","AccountService","ChannelService","GameService","UserService","toaster","$interval","uiCalendarConfig","$anchorScroll","$location",function(e,t,n,o,r,a,s,i,c,l,u,d,m,g,p,f,h){function v(e,t,n){for(var o=0,r=e.length;o<r;o++)if(e[o][n]===t)return o;return-1}l.register("org.celstec.arlearn2.beans.game.Game",function(t){u.refreshGame(t.gameId).then(function(t){e.game=t,e.phases=t.phases}),m.success({title:"Inquiry template modified",body:'The inquiry "'+e.game.title+'" has been modified.'})}),l.register("org.celstec.arlearn2.beans.notification.GeneralItemModification",function(e){i.refreshActivity(e.itemId,e.gameId),m.success({title:"Activity modified",body:"The structure of the activity has been modified."})}),e.lists=[],e.selection=[],u.getGameById(n.gameId).then(function(t){t.error?e.showNoAccess=!0:e.show=!0,e.game=t,e.game.config.roles||(e.game.config.roles=[]),e.game.config.roles2||(e.game.config.roles2=[]),e.phases=e.game.phases,t.lat&&(e.coords.latitude=t.lat,e.coords.longitude=t.lng,e.map.center.latitude=t.lat,e.map.center.longitude=t.lng,e.showMap=!0),e.list_original=[{name:"Add text activity",type:"org.celstec.arlearn2.beans.generalItem.NarratorItem",icon:"fa-file-text"},{name:"Add external resource",type:"org.celstec.arlearn2.beans.generalItem.VideoObject",icon:"fa-external-link"},{name:"Add list activity",type:"org.celstec.arlearn2.beans.generalItem.AudioObject",icon:"fa-tasks"},{name:"Add data collection",type:"org.celstec.arlearn2.beans.generalItem.ScanTag",icon:"fa-picture-o"}],i.getActivitiesServer(n.gameId)}),e.activities=i.getActivities(),e.events=[],e.events=i.getCalendarActivities()[n.gameId],angular.isUndefined(e.events)&&(e.events=i.getCalendarActivities()),e.updateCalendar=function(){},e.eventSources=[e.events],e.alertOnEventClick=function(t,n,o,r){e.editActivity(t.activity,t.activity.gameId)},e.alertOnDrop=function(e,t,n,o,r,a,s,c){e.activity.timestamp+=86400*t*1e3,e.activity.timestamp=new Date(e.activity.timestamp),i.newActivity(e.activity).then(function(e){i.refreshActivity(e.id,e.gameId)})},e.alertOnResize=function(t,n,o,r,a,s,i){e.alertMessage=t.title+": Resized to make dayDelta "+o},e.uiConfig={calendar:{firstDay:1,height:450,editable:!0,header:{left:"prev,next,today",center:"title",right:"month,agendaWeek,agendaDay"},eventClick:e.alertOnEventClick,eventDrop:e.alertOnDrop,eventResize:e.alertOnResize}},e.ok=function(){u.newGame(e.game),m.success({title:"Inquiry template modified",body:'The inquiry "'+e.game.title+'" has been modified.'})},e.gotoAnchor=function(e){var t="anchor"+e;h.hash()!==t?h.hash(e):f()},e.addRole=function(){u.addRole(e.game.gameId,e.role).then(function(t){e.game=t}),m.success({title:"Role added to inquiry",body:'The role "'+e.role.name+'" has been added.'}),e.role=null},e.editRole=function(t){u.editRole(e.game.gameId,e.role,e.index).then(function(t){e.game=t}),m.success({title:"Role modified",body:'The role "'+e.role.name+'" has been edited.'}),e.role=null},e.clearRole=function(t){e.role=null},e.selectRole=function(t){e.index=t,e.role=e.game.config.roles2[t],e.removeRole=function(){u.removeRole(e.game.gameId,e.role).then(function(t){e.game=t}),m.warning({title:"Role deleted",body:'The role "'+e.role.name+'" has been removed.'}),e.role=null}},e.getRoleName=function(e){if(!angular.isUndefined(e))try{if(!angular.isUndefined(e[0]))return e[0].name}catch(e){return"-"}return"-"},e.getRoleColor=function(e){if(!angular.isUndefined(e))try{if(!angular.isUndefined(e[0]))return{"border-left":"3px solid "+e[0].color}}catch(e){return{"border-left":"3px solid #2f4050"}}return{"border-left":"3px solid #2f4050"}},e.currentPhase=0,e.addPhase=function(){swal({title:"New phase",text:"Are you sure you want to add a phase?",type:"input",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, create it!",inputPlaceholder:"New phase name",closeOnConfirm:!1},function(t){return t!==!1&&(""===t?(swal.showInputError("You need to write something!"),!1):(swal("Well done!","New phase created","success"),e.phases.push({title:t,type:"org.celstec.arlearn2.beans.game.Phase"}),m.success({title:"Phase added",body:'The phase "'+e.phaseName+'" has been added to the inquiry template.'}),e.phaseName="",e.game.phases=e.phases,void u.newGame(e.game).then(function(t){angular.forEach(e.gameRuns,function(e,n){e.game=t,s.storeInCache(e)})})))})},e.removePhase=function(t){swal({title:"Are you sure you want to delete the phase?",text:"You will not be able to recover this phase!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete the phase!",closeOnConfirm:!1},function(){swal("Phase deleted!","The phase has been removed from the inquiry structure.","success"),m.warning({title:"Phase removed",body:'The phase "'+e.phases[t].title+'" has been removed from the inquiry template.'}),e.phases.splice(t,1),e.game.phases=e.phases,u.newGame(e.game).then(function(t){angular.forEach(e.gameRuns,function(e,n){e.game=t,s.storeInCache(e)})}),i.getActivitiesForPhase(e.game.gameId,t).then(function(e){angular.forEach(e,function(e,t){i.deleteActivity(e.gameId,e.id)})})})},e.movePhase=function(t,n){swal({title:"Moving phase "+t+" to phase "+n,text:"You will switch phase positions. Current phase "+t+" will be "+n+" and phase "+n+" will be phase "+t,type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, move them!",closeOnConfirm:!1},function(){swal("Phase moved!","Phases have been reordered","success");var o=e.phases[n],r=e.lists[n];e.phases[n]=e.phases[t],e.lists[n]=e.lists[t],e.phases[t]=o,e.lists[t]=r,angular.forEach(e.lists[t],function(e,n){e.section=t,i.newActivity(e).then(function(e){})}),angular.forEach(e.lists[n],function(e,t){e.section=n,i.newActivity(e).then(function(e){})}),e.game.phases=e.phases,u.newGame(e.game).then(function(t){angular.forEach(e.gameRuns,function(e,n){e.game=t,s.storeInCache(e)})}),m.success({title:"Phase moved",body:"The phase has been moved successfully."})})},e.renamePhase=function(t){swal({title:"Rename phase "+t+" '"+e.phases[t].title+"'?",text:"Are you sure you want to rename the phase?",type:"input",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, rename it!",inputPlaceholder:"New phase name",closeOnConfirm:!1},function(n){return n!==!1&&(""===n?(swal.showInputError("You need to write something!"),!1):(swal("Well done!","You renamed the phase, now it's called: "+n,"success"),e.phases[t].title=n,e.game.phases=e.phases,u.newGame(e.game).then(function(t){angular.forEach(e.gameRuns,function(e,n){e.game=t,s.storeInCache(e)})}),void m.success({title:"Phase renamed",body:"The phase has been renamed successfully."})))})},s.getParticipateRunsForGame(n.gameId).then(function(t){t.error?e.showNoAccess=!0:e.show=!0,e.gameRuns=t,e.usersRun=[],angular.forEach(e.gameRuns,function(t,n){e.usersRun[t.runId]=[],d.getUsersForRun(t.runId).then(function(n){e.usersRun[t.runId]=n})})}),e.removeRun=function(t){swal({title:"Are you sure you want to delete the inquiry run?",text:"You will not be able to recover this inquiry run!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete the run!",closeOnConfirm:!1},function(){swal("Inquiry run deleted!","The Inquiry Run has been removed from the list of inquiry runs.","success");var n=v(e.gameRuns,t.runId,"runId");n>-1&&e.gameRuns.splice(n,1);s.deleteRun(t.runId)})},e.createInquiryRun=function(){e.run.gameId=n.gameId,e.run.game=e.game,s.newRun(e.run).then(function(t){e.run=t,angular.isUndefined(e.gameRuns)&&(e.gameRuns=[]),angular.isUndefined(e.usersRun)&&(e.usersRun=[]),angular.forEach(e.accountsAccesGame,function(e){1==e.accessRights&&(s.giveAccess(t.runId,e.account,2),s.addUserToRun({runId:t.runId,email:e.account,accountType:e.accountType,localId:e.localId,gameId:t.game.gameId}))}),c.myDetails().then(function(t){e.me=t,s.giveAccess(e.run.runId,t.accountType+":"+t.localId,1),angular.isUndefined(e.usersRun[e.run.runId])&&(e.usersRun[e.run.runId]=[]);var o=[],r=s.addUserToRun({runId:e.run.runId,email:t.accountType+":"+t.localId,accountType:t.accountType,localId:t.localId,gameId:n.gameId});o.push(r),e.gameRuns[e.run.runId]=e.run,angular.extend(e.usersRun[e.run.runId],o),e.run=null})})},e.addUsersToRun=function(t,n){e.runVar=t,e.gameVar=n;var o=r.open({templateUrl:"/src/components/home/add.user.modal.html",controller:"AddUserCtrl",resolve:{run:function(){return e.runVar},game:function(){return e.gameVar}}});o.result.then(function(t){angular.extend(e.usersRun[e.runVar],t)})},c.myDetails().then(function(t){e.me=t}),u.getGameAccesses(n.gameId).then(function(t){e.accountsAccesGame={},angular.forEach(t.gamesAccess,function(t){c.accountDetailsById(t.account).then(function(n){var o=angular.extend({},n,t);e.accountsAccesGame[t.account]=o})})}),e.grantEditorAccess=function(t,n){u.giveAccess(t.gameId,n.accountType+":"+n.localId,1),e.accountsAccesGame[n.account].accessRights=1,angular.forEach(e.gameRuns,function(e){s.giveAccess(e.runId,n.account,2),s.addUserToRun({runId:e.runId,email:n.account,accountType:n.accountType,localId:n.localId,
gameId:e.game.gameId})})},e.revokeEditorAccess=function(t,n){u.giveAccess(t.gameId,n.accountType+":"+n.localId,2),e.accountsAccesGame[n.account].accessRights=2},e.addNewActivity=function(t,o){e.activity={},i.getActivityInCached()&&(e.activity=i.getActivityInCached()),e.activity.section=t;var a=r.open({templateUrl:"/src/components/home/new.activity.modal.html",controller:"NewActivityController",resolve:{activity:function(){return e.activity},game:function(){return o}}});a.result.then(function(t){angular.isUndefined(e.lists[t.section])&&(e.lists[t.section]=[]),i.newActivity(t).then(function(o){i.getActivityById(o.id,n.gameId).then(function(n){angular.isUndefined(t.roles2)&&e.lists[t.section].push(n)})}),console.log("Modal Accepted!!!")},function(){console.log("Modal Dismissed!!!"),i.saveActivityInCache(e.activity)})},e.editActivity=function(e,t){var n=r.open({templateUrl:"/src/components/home/new.activity.modal.html",controller:"NewActivityController",resolve:{activity:function(){return e},game:function(){return t}}});n.result.then(function(e){console.log(e),i.newActivity(e).then(function(e){i.refreshActivity(e.id,e.gameId)})})},e.wscrolltop="",e.sortableFirst=!1,e.sortableOptions={scroll:!1,"ui-floating":"auto",start:function(t,n){e.sortableFirst&&(e.wscrolltop=$(window).scrollTop()),e.sortableFirst=!0},sort:function(t,n){n.helper.css({top:n.position.top+e.wscrolltop+"px"})},stop:function(e,t){t.item.scope().activity,event.target;$.map($(this).find("li"),function(e){var t=$(e).index();e=angular.fromJson(e.id),e.sortKey=t,i.newActivity(e).then(function(e){})})}}}]).controller("NewActivityController",["$scope","$stateParams","$modalInstance","GameService","ActivityService","Upload","activity","game","config","$interval",function(e,t,n,o,r,a,s,i,c,l){e.saveActivity=function(){angular.isUndefined(e.activity.id)?r.saveActivityInCache(e.activity):r.newActivity(e.activity).then(function(e){r.refreshActivity(e.id,e.gameId)})},e.list_original=[{name:"Discussion activity",type:"org.celstec.arlearn2.beans.generalItem.NarratorItem",icon:"fa-file-text"},{name:"External resource",type:"org.celstec.arlearn2.beans.generalItem.VideoObject",icon:"fa-external-link"},{name:"List activity",type:"org.celstec.arlearn2.beans.generalItem.AudioObject",icon:"fa-tasks"},{name:"Data collection",type:"org.celstec.arlearn2.beans.generalItem.ScanTag",icon:"fa-picture-o"}],e.game=i,e.activity=s,e.activity.fileReferences=[],e.activity.gameId=t.gameId,e.dateOptions={format:"dd/mm/yyyy"},null==s.type&&(s.type=e.list_original[0].type),o.getGameAssets(t.gameId).then(function(t){e.assets=t}),e.upload=function(n){e.progressPercentage=0,n&&(n.name=n.name.replace(/\s+/g,"_"),console.log(s,n),r.uploadUrl(t.gameId,s.id,n.name.replace(/\s+/g,"_")).$promise.then(function(r){a.rename(n,n.name.replace(/\s+/g,"_")),a.upload({url:r.uploadUrl,data:{file:n}}).then(function(r){switch(!0){case/video/.test(r.config.data.file.type):break;case/image/.test(r.config.data.file.type):console.log(r),console.log(c),console.log(c.server+"/generalItems/"+s.gameId+"/"+n.name.replace(/\s+/g,"_"));break;case/pdf/.test(r.config.data.file.type):break;case/audio/.test(r.config.data.file.type):break;case/wordprocessingml|msword/.test(r.config.data.file.type):console.log(r.config.data.file.type);break;case/vnd.ms-excel|spreadsheetml/.test(r.config.data.file.type):console.log(r.config.data.file.type)}o.getGameAssets(t.gameId).then(function(t){e.assets=t}),console.log(r),console.log("Success "+r.config.data.file.name+" uploaded by: "+r.config.data)},function(e){console.log(e),console.log("Error "+e.config.data.file.name+" from: "+e.config.data.username),console.log("Error status: "+e.status)},function(t){var n=parseInt(100*t.loaded/t.total);e.progressPercentage=n,console.log("progress: "+n+"% "+t.config.data.file.name)})}))},e.ok=function(){angular.isUndefined(e.activity.id)&&r.removeCachedActivity();var t=[];angular.forEach(e.activity.roles2,function(e){t.push(angular.fromJson(e))}),e.activity.roles2=t,"org.celstec.arlearn2.beans.generalItem.AudioObject"==e.activity.type&&(""==e.activity.audioFeed?e.activity.audioFeed="-":angular.isUndefined(e.activity.audioFeed)&&(e.activity.audioFeed="-")),"org.celstec.arlearn2.beans.generalItem.VideoObject"==e.activity.type&&(""==e.activity.videoFeed?e.activity.videoFeed="-":angular.isUndefined(e.activity.videoFeed)&&(e.activity.videoFeed="-")),n.close(e.activity)},e.removeActivity=function(e){swal({title:"Are you sure?",text:"You will not be able to recover this activity!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){swal("Deleted!","The activity has been removed from the inquiry structure.","success"),r.deleteActivity(e.gameId,e),n.dismiss("cancel")})},e.cancel=function(){n.dismiss("cancel")}}]).controller("AddUserCtrl",["$scope","$modalInstance","AccountService","RunService","run","game",function(e,t,n,o,r,a){e.refreshAccounts=function(t){n.searchAccount(t).then(function(t){e.availableColors=t.accountList})},e.multipleDemo={},e.multipleDemo.colors=[],e.ok=function(){var n=[];angular.forEach(e.multipleDemo.colors,function(e,t){o.giveAccess(r,e.accountType+":"+e.localId,1);var s=o.addUserToRun({runId:r,email:e.accountType+":"+e.localId,accountType:e.accountType,localId:e.localId,gameId:a});n.push(s)}),t.close(n)},e.cancel=function(){t.dismiss("cancel")}}]).controller("TabController",["$scope","$stateParams","GameService","ActivityService",function(e,t,n,o){this.tab=0,n.getGameById(t.gameId).then(function(t){t.config.roles&&(e.roles=t.config.roles),e.game=t}),this.setTab=function(e){this.tab=e},this.isSet=function(e){return this.tab===e}}]),angular.module("DojoIBL").controller("HomeController",["$scope","$sce","Game","GameService","ActivityService","config","Session","RunService","ChannelService","AccountService",function(e,t,n,o,r,a,s,i,c,l){function u(){o.resumeLoadingGames().then(function(t){t.error?e.showNoAccess=!0:(e.show=!0,t.resumptionToken&&u())})}function d(e,t,n){for(var o=0,r=e.length;o<r;o++)if(e[o][n]===t)return o;return-1}e.games={},e.runs={},u(),e.games=o.getGames(),e.thumbnailUrl=function(e){return a.server+"/game/"+e+"/gameThumbnail"},e.showRunsValue=!0,e.showRuns=function(t){e.gameSelected=t,i.getParticipateRunsForGame(t).then(function(n){e.runs[t]={},e.runs[t]=n})},l.myDetails().then(function(t){e.myAccount=t}),e.cloneInquiry=function(e){swal({title:"Clone inquiry",text:"Are you sure you want to clone the inquiry?",type:"input",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, clone it!",inputPlaceholder:"Title of the cloned inquiry",closeOnConfirm:!1},function(t){return t!==!1&&(""===t?(swal.showInputError("You need to write something!"),!1):(swal("Well done!","You have cloned the inquiry","success"),void o.cloneInquiry(e,t)))})},e.deleteInquiry=function(t){swal({title:"Are you sure?",text:"You will not be able to recover this inquiry!",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){swal("Deleted!","Your inquiry has been deleted.","success");var n=d(e.games,o.getGameFromCache(t).gameId,"gameId");n>-1&&e.games.splice(n,1),o.deleteGame(t)})},e.config={itemsPerPage:5,fillLastPage:!0},e.isLoggedIn=function(){return!!s.getAccessToken()},c.register("org.celstec.arlearn2.beans.game.Game",function(e){angular.isUndefined(e.gameId)||o.refreshGame(e.gameId)}),e.findAndJoin=function(){i.getRunByCode(e.inquiryCode).then(function(e){l.myDetails().then(function(t){console.log(t),o.giveAccess(e.game.gameId,t.accountType+":"+t.localId,2),i.giveAccess(e.runId,t.accountType+":"+t.localId,2),i.addUserToRun({runId:e.runId,email:t.accountType+":"+t.localId,accountType:t.accountType,localId:t.localId,gameId:e.game.gameId}),window.location.href=a.server+"/main.html#/inquiry/"+e.runId})}),e.inquiryCode=null},e.gameSelected}]),angular.module("DojoIBL").controller("LandingController",["$scope","Session","Oauth",function(e,t,n){e.oauth=t.getOauthType,e.accessToken=t.getAccessToken(),e.isLoggedIn=function(){return!(!e.accessToken()||!e.oauth())},e.loading=!0;var o={};n.info().$promise.then(function(t){for(var n=0;n<t.oauthInfoList.length;n++)o["prov"+t.oauthInfoList[n].providerId]=t.oauthInfoList[n],5==t.oauthInfoList[n].providerId&&(e.wespotUrl="https://wespot-arlearn.appspot.com/Login.html?client_id="+o.prov5.clientId+"&redirect_uri="+o.prov5.redirectUri+"&response_type=code&scope=profile+email");e.loading=!1,console.log(o)}),e.providerExists=function(e){return null!=o["prov"+e]},e.fbUrl=function(){return o.prov1?"https://graph.facebook.com/oauth/authorize?client_id="+o.prov1.clientId+"&display=page&redirect_uri="+o.prov1.redirectUri+"&scope=email":""},e.googleUrl=function(){return"https://accounts.google.com/o/oauth2/auth?redirect_uri="+o.prov2.redirectUri+"&response_type=code&client_id="+o.prov2.clientId+"&approval_prompt=force&scope=https://www.googleapis.com/auth/userinfo.profile%20%20https://www.googleapis.com/auth/userinfo.email"},e.wespotUrl=function(){return"https://wespot-arlearn.appspot.com/Login.html?client_id="+o.prov5.clientId+"&redirect_uri="+o.prov5.redirectUri+"&response_type=code&scope=profile+email"}}]),angular.module("DojoIBL").controller("InstantMessagingController",["$window","$scope","$stateParams","Message","MessageService","ChannelService","AccountService","UserService","ngAudio",function(e,t,n,o,r,a,s,i,c){function l(e){var t={};t.body=e.body,s.accountDetailsById(e.senderProviderId+":"+e.senderId).then(function(e){if(t.icon=e.picture,t.title=e.name,console.log(t),"Notification"in window)if("granted"===Notification.permission){new Notification(t.title,{body:t.body,icon:t.icon})}else"denied"!==Notification.permission&&Notification.requestPermission(function(e){if("granted"===e){new Notification(t.title,{body:t.body,icon:t.icon})}});else alert("This browser does not support desktop notification")})}var u=function(e){i.getUsersForRun(e).then(function(e){t.usersRun=e}).then(function(){t.messages={},t.messages.messages=[],t.loadMoreButton=!1,t.disableMessagesLoading=!1,t.messages.messages=r.getMessages(n.runId)})};t.scroll=0,s.myDetails().then(function(e){t.myAccount=e}),t.$on("inquiry-run",function(e,n){t.disableMessagesLoading=!0,u(n.runId)}),t.account=s.myDetailsCache(),u(n.runId),t.bodyMessage,t.glued=!0,t.sendMessage=function(){var e=t.bodyMessage;t.bodyMessage=null,s.myDetails().then(function(t){e&&r.newMessage({runId:n.runId,threadId:t.accountType+":"+t.localId,subject:"empty",body:e}).then(function(e){})})},t.numberMessages=0,a.register("org.celstec.arlearn2.beans.run.Message",function(e){e.runId==n.runId&&(t.numberMessages+=1,r.getMessageById(e.messageId).then(function(n){t.account.localId!=n.senderId&&(console.info("[Notification][Message]",e,t.account.localId,n.senderId),l(e))}))}),t.notifications=[],t.waitingForData=function(){0==t.notifications.length}}]),angular.module("DojoIBL").controller("OauthController",["$scope","$stateParams","Session","$location",function(e,t,n,o){e.token=t.accessToken,e.type=t.type,e.expires=t.expires,n.setAccessToken(t.accessToken),o.path("/home")}]),angular.module("DojoIBL").controller("CalendarController",["$scope","$sce","$stateParams","$state","Response","ActivityService","UserService","GameService","RunService","AccountService","ChannelService","$location",function(e,t,n,o,r,a,s,i,c,l,u,d){u.register("org.celstec.arlearn2.beans.notification.GeneralItemModification",function(e){a.refreshActivity(e.itemId,e.gameId),toaster.success({title:"Activity modified",body:"The structure of the activity has been modified."})}),e.events=[],c.getRunById(n.runId).then(function(e){a.getActivitiesServer(e.gameId)}),e.events=a.getCalendarActivities()[n.gameId],e.eventSources=[e.events],e.alertOnEventClick=function(t,o,r,a){e.goToActivity(n.runId,t.activity.section,t.activity.id)},e.uiConfig={calendar:{firstDay:1,height:450,editable:!0,header:{left:"prev,next,today",center:"title",right:"month,agendaWeek,agendaDay"},eventClick:e.alertOnEventClick,disableDragging:!0,views:{basic:{},agenda:{},week:{},day:{}}}},e.goToActivity=function(e,t,n){d.path("inquiry/"+e+"/phase/"+t+"/activity/"+n)}}]),angular.module("DojoIBL").controller("InquiryController",["$scope","$sce","$location","$stateParams","$state","Session","MessageService","ActivityService","AccountService","ChannelService","RunService",function(e,t,n,o,r,a,s,i,c,l,u){e.chat=!0,e.visualization=!0,e.state=r.current.name,e.inqTitle="",e.disableInquiryLoading=!1,u.getRunById(o.runId).then(function(t){e.inqTitle=t.title,e.inqTempTitle=t.game.title,e.inqDescription=t.game.description,e.inqId=t.runId,e.phases=t.game.phases,e.code=t.code,e.serverCreationTime=t.serverCreationTime,e.disableInquiryLoading=!0,i.getActivitiesServer(t.gameId)}),e.activities=i.getActivities(),e.goToPhase=function(e,t){n.path("inquiry/"+e+"/phase/"+t)},e.goToActivity=function(e,t,o){n.path("inquiry/"+e+"/phase/"+t+"/activity/"+o)},e.getRoleName=function(e){if(!angular.isUndefined(e))try{if(!angular.isUndefined(e[0]))return e[0].name}catch(e){return"-"}return"-"},e.getRoleColor=function(e){if(!angular.isUndefined(e))try{if(!angular.isUndefined(e[0]))return{"border-left":"3px solid "+e[0].color}}catch(e){return{"border-left":"3px solid #2f4050"}}return{"border-left":"3px solid #2f4050"}};var d=($(this.el).find("#circlemenu li"),$("#circlemenu")),m=d.width(),g=200,p=300,f=100;e.calculateLeft=function(t){return p+=2*Math.PI/e.phases.length,p*=t,Math.round(m/2+f*Math.cos(p)-m/2)},e.calculateTop=function(e,t){return p+=2*Math.PI/e.length,p*=t,Math.round(g/2+f*Math.sin(p)-g/2)}}]),angular.module("DojoIBL").controller("InquiryEditRunController",["$scope","$sce","$stateParams","$state","Session","RunService","UserService","Contacts",function(e,t,n,o,r,a,s,i){function c(e,t,n){for(var o=0,r=e.length;o<r;o++)if(e[o][n]===t)return o;return-1}e.roles=[],a.getRunById(n.runId).then(function(t){t.error?e.showNoAccess=!0:e.show=!0,e.game=t.game,e.game.config.roles||(e.game.config.roles=[]),e.run=t,t.lat&&(e.coords.latitude=t.lat,e.coords.longitude=t.lng,e.map.center.latitude=t.lat,e.map.center.longitude=t.lng,e.showMap=!0)}),s.getUsersForRun(n.runId).then(function(t){e.usersRun=t}),e.ok=function(){e.run.runId?a.updateRun(e.run):a.newRun(e.run)},e.removeAccess=function(t,n){swal({title:"Remove user from inquiry",text:"Are you sure you want to remove this student from the inquiry?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, remove the student!",closeOnConfirm:!1},function(){swal("Student removed!","The student has been removed from the list of participants in this inquiry.","success"),console.log(e.usersRun,t,n.email);var o=c(e.usersRun,n.email,"email");o>-1&&e.usersRun.splice(o,1),a.removeAccessToInquiryRun(t,n)})},e.friends=[],i.getContacts({date:0}).$promise.then(function(t){for(var n=0;n<t.accountList.length;n++)e.friends.push(t.accountList[n])})}]),angular.module("DojoIBL").controller("TimelineController",["$scope","$sce","$stateParams","$state","Response","ActivityService","UserService","GameService","RunService","AccountService","ChannelService",function(e,t,n,o,r,a,s,i,c,l,u){function d(e){return Object.keys(e).every(function(t){return!e[t]})}e.games={},e.games.games=[],e.disableGameLoading=!1;var m=0,g=!0;u.register("org.celstec.arlearn2.beans.run.Response",function(t){if(t.runId==n.runId){var o=[];t.generalItemId!=m&&(g?t.move_right=!1:t.move_right=!0),m=t.generalItemId,g=t.move_right,c.getRunById(n.runId).then(function(e){a.getActivityById(t.generalItemId,e.gameId).then(function(e){t.activity=e})}),t.user=s.getUser(n.runId,t.userEmail),o.push(t),e.games.games=o.concat(e.games.games)}}),e.loadMoreGames=function(){e.disableGameLoading=!0,r.resume({resumptionToken:e.games.resumptionToken,runId:n.runId,from:0}).$promise.then(function(t){var o=[];angular.forEach(t.responses,function(e){e.generalItemId!=m&&(g?e.move_right=!1:e.move_right=!0),m=e.generalItemId,g=e.move_right,c.getRunById(n.runId).then(function(t){a.getActivityById(e.generalItemId,t.gameId).then(function(t){e.activity=t})}),e.user=s.getUser(n.runId,e.userEmail),o.push(e)}),e.games.games=e.games.games.concat(o),e.games.resumptionToken=t.resumptionToken,e.games.serverTime=t.serverTime,t.resumptionToken?e.disableGameLoading=!1:e.disableGameLoading=!0})},s.getUsersForRun(n.runId).then(function(t){e.usersRun=t}),e.filter={},e.filterByCategory=function(t){return e.filter[t.user.localId]||d(e.filter)}}]);